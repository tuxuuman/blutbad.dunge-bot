// ==UserScript==
// @name         [blutbad.ru] DungeBot
// @namespace    tuxuuman:blutbad:dangebot
// @version      1.0
// @description  Бот для прохождения данжей
// @author       tuxuuman<tuxuuman@gmail.com>
// @match        http://damask.blutbad.ru/dungeon.php*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @grant        unsafeWindow
// @require      https://cdnjs.cloudflare.com/ajax/libs/fast-xml-parser/3.10.0/parser.js
// @require      https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js
// @require      https://cdn.jsdelivr.net/npm/vue/dist/vue.js
// ==/UserScript==

'use strict';var _slicedToArray=function(){function b(c,d){var e=[],f=!0,g=!1,h=void 0;try{for(var k,j=c[Symbol.iterator]();!(f=(k=j.next()).done)&&(e.push(k.value),!(d&&e.length===d));f=!0);}catch(l){g=!0,h=l}finally{try{!f&&j['return']&&j['return']()}finally{if(g)throw h}}return e}return function(c,d){if(Array.isArray(c))return c;if(Symbol.iterator in Object(c))return b(c,d);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),_typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(b){return typeof b}:function(b){return b&&'function'==typeof Symbol&&b.constructor===Symbol&&b!==Symbol.prototype?'symbol':typeof b};(function(){'use strict';if(window.title='SCRIPT LOADED',document.getElementById('flashdungeon')){var cmd=async function(b,c){var d='http://damask.blutbad.ru/dungeon_xml.php'+querystring(Object.assign({cmd:b,nd:getCookie('nd')},c))+'&'+Math.random(),e=await fetch(d),f=await e.text();if(parser.validate(f))return parser.parse(f,{ignoreAttributes:!1,parseAttributeValue:!0,attributeNamePrefix:''});throw console.error('invalid xml data'),new Error('invalid xml data')},getCookie=function(b){var c=document.cookie.match(new RegExp('(?:^|; )'+b.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,'\\$1')+'=([^;]*)'));return c?decodeURIComponent(c[1]):void 0},findPointObject=function(b,c,d){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var f,e=Object.values(d.objects)[Symbol.iterator]();!(_iteratorNormalCompletion2=(f=e.next()).done);_iteratorNormalCompletion2=!0){var g=f.value,h=[];Array.isArray(g.object)?h=g.object:'object'==_typeof(g.object)&&(h=[g.object]);var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var k,l,j=h[Symbol.iterator]();!(_iteratorNormalCompletion3=(k=j.next()).done);_iteratorNormalCompletion3=!0)if(l=k.value,l.position.x==b&&l.position.y==c)return{x:l.position.x,y:l.position.y,type:l.type.value,id:l.id.value}}catch(n){_didIteratorError3=!0,_iteratorError3=n}finally{try{!_iteratorNormalCompletion3&&j.return&&j.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}}catch(n){_didIteratorError2=!0,_iteratorError2=n}finally{try{!_iteratorNormalCompletion2&&e.return&&e.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return null},getWays=function(b){var c={},_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var e,d=b.ways.position[Symbol.iterator]();!(_iteratorNormalCompletion4=(e=d.next()).done);_iteratorNormalCompletion4=!0){var f=e.value,g=findPointObject(f.x,f.y,b);c[f.x+'_'+f.y]=g||f}}catch(h){_didIteratorError4=!0,_iteratorError4=h}finally{try{!_iteratorNormalCompletion4&&d.return&&d.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return c},rnd=function(){var c,d;return 2==b.length?(c=0>=b.length?void 0:b[0],d=1>=b.length?void 0:b[1]):(c=0,d=0>=b.length?void 0:b[0]),Math.floor(Math.random()*d+c)},getDungeCfg=async function(){if(dungeCfg)return dungeCfg;var b=await cmd('getcfg');b.typedescription={};var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var d,_loop=function(){var e=d.value;if(e.action){var f=b.datastorage.actiondescription.action.find(function(g){return g.id==e.action.id});e.action.cmd=f.cmd}b.typedescription[e.id]=e},c=b.datastorage.typedescription.type[Symbol.iterator]();!(_iteratorNormalCompletion5=(d=c.next()).done);_iteratorNormalCompletion5=!0)_loop()}catch(e){_didIteratorError5=!0,_iteratorError5=e}finally{try{!_iteratorNormalCompletion5&&c.return&&c.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return dungeCfg=b},querystring=function(b){return Object.keys(b).reduce(function(c,d,e){var f,g;return f=0===e?'?':'&',d=encodeURIComponent(d),g=encodeURIComponent(b[d]),[c,f,d,'=',g].join('')},'')},parseActions=function(b){return b.split('\n').map(function(c){var d=c.split(' ').filter(function(f){return f});if(d.length){var e=d[0].toLowerCase();if(actions.includes(e))return{name:e,params:d.splice(1)}}}).filter(function(c){return c})},validateXmlData=function(b){if(!b.world&&b.javascript)throw{message:'\u0412 \u043E\u0442\u0432\u0435\u0442\u0435 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u0442\u0441\u044F JS \u043A\u043E\u0434',name:'xmlDataJs',js:b.javascript.value};else if(!b.world)throw console.error('\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u043F\u043E\u043B\u043D\u0438\u0442\u044C \u043A\u043E\u043C\u0430\u043D\u0434\u0443 "'+command.name+'".',b),new Error('\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u043F\u043E\u043B\u043D\u0438\u0442\u044C \u043A\u043E\u043C\u0430\u043D\u0434\u0443 "'+command.name+'".');return b},rotateTo=async function(b){for(var d,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:'L';;)if(d=validateXmlData((await cmd('turnXML',{direction:c}))),d.world.hero.direction.value==b)return d},getWay=function(b,c,d){return b[c+'_'+d]},lookAround=function(b,c){var d={},f=[[-1,0,'w'],[1,0,'e'],[0,-1,'n'],[0,1,'s']],_iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var h,g=f[Symbol.iterator]();!(_iteratorNormalCompletion6=(h=g.next()).done);_iteratorNormalCompletion6=!0){var j=h.value,k=getWay(b,c.x+j[0],c.y+j[1]);k&&(0==k.type.indexOf('obj_')||0==k.type.indexOf('bot_'))&&(d[j[2]]=k)}}catch(l){_didIteratorError6=!0,_iteratorError6=l}finally{try{!_iteratorNormalCompletion6&&g.return&&g.return()}finally{if(_didIteratorError6)throw _iteratorError6}}return d},excBotCommand=async function(b){async function c(t){if(!g[t])e.direction.value!=t&&(console.log('\u0420\u0430\u0437\u0432\u043E\u0440\u0430\u0447\u0438\u0432\u0430\u0435\u043C\u0441\u044F '+b.name+'..'),await rotateTo(t)),console.log('\u0414\u0435\u043B\u0430\u0435\u043C \u0448\u0430\u0433'),await cmd('moveXML',{direction:'up'});else throw new Error('\u041D\u0435\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0441\u0434\u0435\u043B\u0430\u0442\u044C \u0448\u0430\u0433 '+b.name)}console.log('\u0432\u044B\u043F\u043E\u043B\u043D\u044F\u0435\u0442\u0441\u044F \u043A\u043E\u043C\u0430\u043D\u0434\u0430:'+b.name);var d=validateXmlData((await cmd('updateXML'))),e=d.world.hero,f=getWays(d.world),g=lookAround(f,e.position),_iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{for(var r,s,q=Object.values(g)[Symbol.iterator]();!(_iteratorNormalCompletion7=(r=q.next()).done);_iteratorNormalCompletion7=!0)if(s=r.value,0==s.type.indexOf('bot_'))throw{name:'BattleBegin',mob:s}}catch(t){_didIteratorError7=!0,_iteratorError7=t}finally{try{!_iteratorNormalCompletion7&&q.return&&q.return()}finally{if(_didIteratorError7)throw _iteratorError7}}switch(b.name){case'\u043D\u0430\u043B\u0435\u0432\u043E':await c('w');break;case'\u043D\u0430\u043F\u0440\u0430\u0432\u043E':await c('e');break;case'\u0432\u0432\u0435\u0440\u0445':await c('n');break;case'\u0432\u043D\u0438\u0437':await c('s');break;case'\u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C':var h=await getDungeCfg(),j=async function(t){if(t){var u=h.typedescription[t.type];u.action?(console.log('\u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C',t.type),await cmd(u.action.cmd,{objectId:t.id})):console.log(t.type,'\u043D\u0435\u043B\u044C\u0437\u044F \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C')}else console.warn('\u043D\u0435\u043B\u044C\u0437\u044F \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u043E\u0431\u044A\u0435\u043A\u0442')};if(b.params.length){var _command$params=_slicedToArray(b.params,1),k=_command$params[0],l=null;'\u0441\u043B\u0435\u0432\u0430'===k?l=g.w:'\u0441\u043F\u0440\u0430\u0432\u0430'===k?l=g.e:'\u0441\u043D\u0438\u0437\u0443'===k?l=g.s:'\u0441\u0432\u0435\u0440\u0445\u0443'===k?l=g.n:void 0,await j(l)}else{var _iteratorNormalCompletion8=!0,_didIteratorError8=!1,_iteratorError8=void 0;try{for(var o,p,n=Object.values(g)[Symbol.iterator]();!(_iteratorNormalCompletion8=(o=n.next()).done);_iteratorNormalCompletion8=!0)p=o.value,await j(p)}catch(t){_didIteratorError8=!0,_iteratorError8=t}finally{try{!_iteratorNormalCompletion8&&n.return&&n.return()}finally{if(_didIteratorError8)throw _iteratorError8}}}break;default:throw new Error('\u041D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u0430\u044F \u043A\u043E\u043C\u0430\u043D\u0434\u0430: "'+b.name+'"');}},notify=function(b,c){var d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:'';c?console.error(b,c,d):console.log(b,c,d),showNotification(b,c,'[BOT]'+d)},loadBotCfg=function(b){return GM_getValue(b)},setBotCfg=function(b,c){GM_setValue(b,Object.assign({actionsCfg:'',started:!1,currentActionIndex:0,currentActionProgress:0},c))},updateBotCfg=function(b,c){setBotCfg(b,Object.assign(loadBotCfg(b),c))};console.log('SCRIPT LOADED');var dungeCfg=null,actions=['\u043D\u0430\u043B\u0435\u0432\u043E','\u043D\u0430\u043F\u0440\u0430\u0432\u043E','\u0432\u0432\u0435\u0440\u0445','\u0432\u043D\u0438\u0437','\u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C'];unsafeWindow.__oldShowItems=unsafeWindow.showItems,unsafeWindow.showItems=function(b){unsafeWindow.__oldShowItems.call(unsafeWindow,b);var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var d,e,c=b[Symbol.iterator]();!(_iteratorNormalCompletion=(d=c.next()).done);_iteratorNormalCompletion=!0)e=d.value,unsafeWindow.send_ajax(e.type,e.num,e.entry)}catch(f){_didIteratorError=!0,_iteratorError=f}finally{try{!_iteratorNormalCompletion&&c.return&&c.return()}finally{if(_didIteratorError)throw _iteratorError}}console.log(b)},GM_addStyle('\n.modal {\n    position: fixed;\n    z-index: 999;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    overflow: auto;\n    background-color: rgb(0,0,0);\n    background-color: rgba(0,0,0,0.4);\n}\n\n.modal-content {\n    background-color: #fefefe;\n    margin: 15% auto;\n    padding: 20px;\n    border: 1px solid #888;\n    width: 300px;\n}\n\n.close {\n    color: #aaa;\n    float: right;\n    font-size: 15px;\n    font-weight: bold;\n}\n\n.close:hover,\n.close:focus {\n    color: black;\n    text-decoration: none;\n    cursor: pointer;\n} \n\n.action-editor {\n    padding: 10px;\n    border: 1px solid black;\n}\n\n.action-editor > textarea {\n    width: 100%;\n    height: 200px;\n    border: none;\n    resize: none;\n    padding: 0;\n}\n\n.way-viewer {\n    height: 200px;\n    border: 1px solid black;\n    overflow: auto;\n    padding: 10px;\n}\n\n.ways-info {\n    border-bottom: 1px solid black;\n}\n\n.xbbutton {\nwidnth: 120px !important;\n}\n');$('body').append('\n<div id="bot-panel" class="modal" v-show="visible">\n\n  <div class="modal-content">\n    <span class="close" @click="visible = false">&times;</span>\n    <div id="botSettingsInfo"></div>\n   \n<div v-if="botStarted">\n\u0411\u043E\u0442 \u0437\u0430\u043F\u0443\u0449\u0435\u043D!\n<button class="xbbutton" @click="stopBot()">Stop</button>\n</div>\n<div v-else>\n<div class="action-editor">\n                    <textarea\n                        autocomplete="off"\n                        autocorrect="off"\n                        autocapitalize="off"\n                        spellcheck="false"\n                        v-model="codeActions"\n                    ></textarea>\n</div>\n\n<div class="way-viewer">\n                    <div class="ways-info">\n                        \u041A\u043E\u043B-\u0432\u043E \u043A\u043E\u043C\u0430\u043D\u0434: {{ actions.length }}\n                    </div>\n                    <pre>{{ actions }}</pre>\n</div>\n<button class="xbbutton" @click="startBot(true)">Start</button>\n</div>\n\n  </div>\n\n</div>\n');var app=new Vue({el:'#bot-panel',data:function data(){return{botStarted:!1,dungeId:'',__codeActions:'',visible:!1}},computed:{actions:function(){return parseActions(this.codeActions)},codeActions:{set:function set(b){this.$data.__codeActions=b},get:function get(){return this.$data.__codeActions}},botConfig:function botConfig(){var b=loadBotCfg(this.dungeId);return console.log('botCfg',b),b}},methods:{setDungeId:function setDungeId(b){this.dungeId=b;var c=this.botConfig;this.codeActions=this.botConfig.actionsCfg,c.started&&this.startBot()},startBot:function startBot(clicked){var _this=this;if(!this.actions.length)return void notify('\u0421\u043F\u0438\u0441\u043E\u043A \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0439 \u043D\u0435 \u043C\u043E\u0436\u0435\u0442 \u0431\u044B\u0442\u044C \u043F\u0443\u0441\u0442\u044B\u043C',!0);if(!this.botStarted){this.botStarted=!0,clicked?(setBotCfg(this.dungeId,{actionsCfg:this.codeActions,started:!0}),notify('\u0411\u043E\u0442 \u0437\u0430\u043F\u0443\u0449\u0435\u043D!')):updateBotCfg(this.dungeId,{actionsCfg:this.codeActions});var aclionList=this.actions,self=this;(async function(){for(;self.botStarted;){var b=loadBotCfg(self.dungeId),c=aclionList[b.currentActionIndex];if(!c)return 1;var d=b.currentActionProgress,e=parseInt(c.params[0])||1;d<e?(await excBotCommand(c),updateBotCfg(self.dungeId,{currentActionProgress:d+1})):updateBotCfg(self.dungeId,{currentActionIndex:b.currentActionIndex+1,currentActionProgress:0})}})().then(function(b){1==b&&_this.stopBot(),notify('\u0411\u043E\u0442 \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B \u0440\u0430\u0431\u043E\u0442\u0443')}).catch(function(err){'xmlDataJs'==err.name?(console.warn('\u0412 \u043E\u0442\u0432\u0435\u0442\u0435 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u0442\u0441\u044F JS. \u0412\u044B\u043F\u043E\u043B\u043D\u044F\u0435\u043C \u0435\u0433\u043E',err),eval(err.js)):'BattleBegin'==err.name?(notify('\u0410\u0442\u0430\u043A\u0443\u0435\u043C \u043C\u043E\u043D\u0441\u0442\u0440\u0430!'),console.warn('\u041D\u0430\u0447\u0438\u043D\u0430\u0435\u043C \u0431\u043E\u0439',err),cmd('attack',{objectId:err.mob.id}).then(function(res){console.log('res',res),res.javascript&&eval(res.javascript.value),res.world&&res.world.javascript&&eval(res.world.javascript.value)}),setTimeout(function(){unsafeWindow.location.reload()},1e4)):(console.error('\u0412 \u0440\u0430\u0431\u043E\u0442\u0435 \u0431\u043E\u0442\u0430 \u043F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430',err),notify('\u0412 \u0440\u0430\u0431\u043E\u0442\u0435 \u0431\u043E\u0442\u0430 \u043F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430 <br/>['+err.message+']',!0),_this.stopBot())})}},stopBot:function stopBot(){this.botStarted&&(this.botStarted=!1,updateBotCfg(this.dungeId,{started:!1}))}}}),botBtn=$('<input/>',{'class':'xbbutton',click:function click(){app.visible=!0},value:'Bot',type:'button'});$('.right-col .buttons').append(botBtn),async function(){var dungeCfg=await getDungeCfg();if(!dungeCfg.datastorage&dungeCfg.javascript)eval(dungeCfg.javascript.value);else if(!dungeCfg.datastorage)throw new Error('\u041D\u0435 \u0432\u0430\u043B\u0438\u0434\u043D\u044B\u0439 \u043A\u043E\u043D\u0444\u0438\u0433 \u043F\u043E\u0434\u0437\u0435\u043C\u0435\u043B\u044C\u044F');var dungeId=dungeCfg.datastorage.mainwinlib.path,xmlData=await cmd('updateXML');app.setDungeId.call(app,dungeId),console.log('dungeCfg',dungeCfg),console.log('xmlData',xmlData)}().catch(console.error)}})();
